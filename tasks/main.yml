---
# tasks file for go
- name: include assert.yml
  include_tasks: assert.yml
  run_once: yes

- name: create lib64 directory
  file:
    path: /lib64
    state: directory
    mode: "0555"
  when:
    - ansible_distribution == "Alpine"

- name: link libc to lib64 directory
  file:
    src: /lib/libc.musl-x86_64.so.1
    dest: /lib64/ld-linux-x86-64.so.2
    state: link
    mode: "0755"
  when:
    - ansible_distribution == "Alpine"

- name: install requirements
  package:
    name: "{{ go_requirements }}"
    state: present

- name: unpack go
  unarchive:
    src: "{{ go_src }}"
    dest: "{{ go_destination }}"
    remote_src: yes
    creates: "{{ go_destination }}/go/bin"
    mode: "0755"

- name: add go_destination to path variable
  template:
    src: go.sh.j2
    dest: "/etc/profile.d/{{ item }}"
    mode: "644"
  loop:
    - go.sh
    - go.csh

- name: link go to a location in PATH
  file:
    src: "{{ go_destination }}/go/bin/go"
    dest: /usr/bin/go
    state: link
    mode: "0755"

- name: create go_path bin directory
  file:
    path: "{{ go_path }}/bin"
    state: directory
    mode: "0755"
  when:
    - go_packages is defined

- name: get requested packages
  command: "go get {{ item }}"
  args:
    creates: "{{ go_path }}/src/{{ item }}"
  loop: "{{ go_packages }}"
  when:
    - go_packages is defined
  environment:
    GOPATH: "{{ go_path }}"

- name: install requested packages
  command: make install
  args:
    chdir: "{{ go_path }}/src/{{ item }}"
    creates: "{{ go_path }}/bin/{{ item | basename }}"
  loop: "{{ go_packages }}"
  when:
    - go_packages is defined
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ go_destination }}/go/bin"
